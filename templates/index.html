<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Papeler√≠a Blanco y Negro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/styleIndex.css') }}">

</head>
<body class="bg-light">

    <div class="barra-superior">
        <div class="logo">
            <!-- <img src="/static/elements/logo.png" alt="Logo" class="logo-img"> -->
        </div>
        <div class="contenido">
        </div>
        <div class="cart">                       
            <a href="{{ url_for('cart') }}" class="btn btn-info cartButton"> <img src="/static/elements/cart.png" alt="Carrito" class="cart-img"></a>
        </div>
        
    </div>
<!-- Men√∫ desplegable en la esquina superior derecha -->
<div class="instructions-dropdown">
    <button class="btn btn-dark dropdown-toggle" type="button" id="instructionsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
        INSTRUCCIONES 
    </button>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="instructionsDropdown">
        <li><strong>CONFIGURACI√ìN</strong></li>
        <li><strong>1:</strong> Selecciona el n√∫mero de copias que deseas imprimir.</li>
        <li><strong>2:</strong> Escoge si deseas impresi√≥n a color o en blanco y negro.</li>
        <li><strong>3:</strong> Elige si quieres impresi√≥n en una o dos caras.</li>
        <li><strong>4:</strong> Selecciona el tama√±o y el grosor del papel.</li>
        <li><strong>CARPETAS</strong></li>
        <li><strong>5:</strong> Haz clic en "Elegir archivos" para seleccionar los documentos que deseas subir.</li>
        <li><strong>6:</strong> Pulsa en "Confirmar" para subir los archivos seleccionados a la carpeta.</li>
        <li><strong>7:</strong> Haz clic en una carpeta para mostrar o modificar su configuraci√≥n.</li>
        <li><strong>8:</strong> Pulsa en "Actualizar Carrito" para reflejar los cambios realizados.</li>
        <li><strong>9:</strong> Ve al carrito para revisar los detalles y procede al pago.</li>
    </ul>
    
</div>
    <div class="container my-5">
        <div id="validation-errors" class="alert"></div>

        <div class="row">
            <!-- Configuraci√≥n de impresi√≥n -->
            <div class="col-md-4 impresionConf">
                <h5>Configuraci√≥n de impresi√≥n</h5>
                <form id="config-form" method="POST">
                    <input type="hidden" name="action" value="update_config">
                    <input type="hidden" name="folder_name" id="active-folder" value="">
                    
        
                    <div class="mb-3 opCopias">
                        <label class="form-label" id="copiasT">Copias</label>
                        <div class="input-group">
                            <button type="button" class="btn btn-outline-secondary" onclick="updateCopies(-1)">-</button>
                            <input type="text" class="form-control text-center" id="copias" name="copias" value="1" readonly>
                            <button type="button" class="btn btn-outline-secondary" onclick="updateCopies(1)" >+</button>
                        </div>
                    </div>

                   <div class="mb-3 opColor">
                        <label class="form-label" id="colorT">Color de la impresi√≥n</label>
                        <div id="color-impresion" class="btn-group w-100" role="group">
                            <button type="button" class="btn btn-outline-primary" id="color-byn" onclick="selectColor('ByN')">ByN</button>
                            <button type="button" class="btn btn-outline-primary" id="color-color" onclick="selectColor('Color')">Color</button>
                        </div>
                        <input type="hidden" name="color" id="color-input" value="ByN">
                    </div>

                    <div class="mb-3 opCaras">
                        <label class="form-label" id="carasT">Una o dos caras</label>
                        <div id="cara-impresion" class="btn-group w-100" role="group">
                            <button type="button" class="btn btn-outline-primary" id="cara-una" onclick="selectEstructura('Una')">Una cara</button>
                            <button type="button" class="btn btn-outline-primary" id="cara-doble" onclick="selectEstructura('Doble')">Doble cara</button>
                        </div>
                        <input type="hidden" name="cara" id="cara-input" value="Una">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Encuadernaci√≥n (A4)</label>
                        <div class="custom-select-wrapper">
                            <select class="form-select custom-select" id="encuadernacion" name="encuadernacion" onchange="updateConfigInActiveFolder('encuadernacion', this.value); calculatePrice(); sendConfigUpdate();">
                                <option value="hasta_50_hojas">Hasta 50 hojas - 1,5 ‚Ç¨</option>
                                <option value="51_a_100_hojas">51 a 100 hojas - 2,0 ‚Ç¨</option>
                                <option value="101_a_150_hojas">101 a 150 hojas - 2,5 ‚Ç¨</option>
                                <option value="151_a_200_hojas">151 a 200 hojas - 3,0 ‚Ç¨</option>
                                <option value="201_a_250_hojas">201 a 250 hojas - 3,5 ‚Ç¨</option>
                                <option value="251_a_300_hojas">251 a 300 hojas - 4,0 ‚Ç¨</option>
                            </select>
                            <span class="custom-arrow"></span>
                        </div>
                    </div>
                    
                    
                    <div class="mb-3">
                        <label for="comentarios" class="form-label">Comentarios adicionales (opcional)</label>
                        <div class="textarea-wrapper">
                            <textarea class="form-control custom-textarea" id="comentarios" name="comentarios" rows="3" placeholder="Ejemplo: Impresi√≥n urgente, entregar antes del mediod√≠a..."></textarea>
                            <span class="textarea-icon">üñäÔ∏è</span>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label" id="modalidadE">Modalidad de env√≠o</label>
                        <div id="envio-opciones" class="btn-group w-100" role="group">
                            <button type="button" class="btn btn-outline-primary" id="envio-tienda" onclick="selectEnvio('tienda')">Recoger en tienda</button>
                            <button type="button" class="btn btn-outline-primary" id="envio-domicilio" onclick="selectEnvio('domicilio')">Env√≠o a domicilio (+4,50 ‚Ç¨)</button>
                        </div>
                        <input type="hidden" name="modalidad_envio" id="modalidad-envio" value=" ">
                    </div>
                    <div class="mb-3" id="form-envio-domicilio" style="display: none;">
                        <label for="name" class="form-label mt-3">Nombre</label>
                        <input type="text" class="form-control" id="name" name="name" placeholder="Nombre y apellidos para identificar tu pedido">

                        <label for="direccion" class="form-label">Direcci√≥n</label>
                        <input type="text" class="form-control" id="direccion" name="direccion" placeholder="Calle, n√∫mero, piso, etc.">
                        
                        <label for="provincia" class="form-label mt-3">Provincia</label>
                        <input type="text" class="form-control" id="provincia" name="provincia" placeholder="Provincia">
                        
                        <label for="email" class="form-label mt-3">Correo electr√≥nico</label>
                        <input type="email" class="form-control" id="email" name="email" placeholder="ejemplo@correo.com">
                        
                        <label for="telefono" class="form-label mt-3">Tel√©fono</label>
                        <input type="tel" class="form-control" id="telefono" name="telefono" placeholder="123-456-789">
                    </div>

                </form>
                <!-- <div id="cart-total" class="alert alert-info">
                    Precio total: 
                    <div id="totalPrize">{{ cart_total }} ‚Ç¨</div>
                </div>             -->
                <div id="cart-total" class="alert alert-info">
                    <p id="totalPrize">Subtotal: {{ cart_total }} ‚Ç¨</p>
                    <p id="envioPrice">Env√≠o: {{ envio_total }} ‚Ç¨</p>
                    <hr>
                    <strong id="finalPrice">Total final: {{ total_con_envio }} ‚Ç¨</strong>
                </div>
                
                
            </div>

            <!-- Vista de carpetas -->
            <div class="col-md-8">
                <form method="POST" enctype="multipart/form-data">
                    <div class="mb-4 d-flex align-items-center">
                        <!-- Bot√≥n de a√±adir carpeta -->
                        <button type="submit" name="action" value="create_folder" class="btn btn-primary addFolder">
                            <img src="/static/elements/addFolder.png" alt="A√±adir Carpeta" class="add-folder-img folderImg">
                        </button>
                        <!-- Bot√≥n de actualizar carrito -->
                        <button type="button" class="btn btn-success ms-auto updateCart" onclick="addToCart()">Actualizar Carrito</button>
                    </div>
                    
                    <div id="no-folders" class="text-center mt-5" style="display: none;">
                        <img src="/static/elements/noFolders.png" alt="No hay carpetas" class="no-folders-img">
                    </div>
                    <div id="folders">
                        {% for folder in folders %}
                        <div 
                        onclick="setActiveFolder('{{ folder.name }}')" 
                        class="p-3 mb-3 border rounded folder-item" 
                        data-folder-name="{{ folder.name }}" 
                        data-config='{{ folder.configuracion | tojson | safe }}'>
                        <h5>{{ folder.name }}</h5>
                            <form method="POST" enctype="multipart/form-data">
                                <input type="hidden" name="folder_name" value="{{ folder.name }}">
                                <div class="mb-3">
                                    <label class="form-label">Selecciona los archivos a imprimir</label>
                                    <div class="d-flex align-items-center gap-3">
                                        <input type="file" class="form-control" name="file" id="fileInput-{{ loop.index }}" multiple onchange="toggleUploadButton({{ loop.index }})">
                                        <button type="submit" name="action" value="upload_to_folder" class="btn btn-primary confirmarSubida" id="uploadButton-{{ loop.index }}" disabled>Confirmar</button>
                                    </div>
                                </div>
                                
                                
                                <!-- <div class="mb-3">
                                    <label class="form-label">Selecciona los archivos a imprimir</label>
                                    <input type="file" class="form-control" name="file" multiple>
                                </div> -->
                            </form>

                            <div class="uploaded-files">
                                {% if folder.archivos %}
                                    <div class="file-grid">
                                        {% for archivo in folder.archivos %}
                                            <div class="file-item">
                                                <img src="/static/elements/pdfIcon.png" alt="PDF Icon" class="file-icon">
                                                <span class="file-name">{{ archivo.name }} - {{ archivo.pages }} p√°ginas</span>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <p>No hay archivos en esta carpeta.</p>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                </form>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.7/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
    
    <script>
        const PRICES = JSON.parse('{{ prices | tojson | safe }}');
        let activeFolderElement = null; // Variable para rastrear la carpeta activa

        function setActiveFolder(folderName) {
            const folderElement = document.querySelector(`[data-folder-name="${folderName}"]`);
            if (!folderElement) return;

                        // Quitar clase `active` de la carpeta previamente seleccionada
            if (activeFolderElement) {
                activeFolderElement.classList.remove('active');
            }

            // A√±adir clase `active` a la nueva carpeta
            folderElement.classList.add('active');
            activeFolderElement = folderElement;
            // Actualiza la carpeta activa
            document.getElementById('active-folder').value = folderName;

            // Actualiza los valores del formulario con la configuraci√≥n actual
            const config = JSON.parse(folderElement.getAttribute('data-config'));

            document.getElementById('copias').value = config.copias || 1;
            document.getElementById('color-input').value = config.color || 'byn';
            document.getElementById('cara-input').value = config.cara || 'una_cara';
            document.getElementById('encuadernacion').value = config.encuadernacion || 'hasta_50_hojas';

            // Actualizar botones activos de color
            updateActiveButton('#color-impresion', config.color === 'Color' ? 'color-color' : 'color-byn');

            // Actualizar botones activos de una/doble cara
            updateActiveButton('#cara-impresion', config.cara === 'Doble' ? 'cara-doble' : 'cara-una');

            // Recalcula el precio
            calculatePrice();
        }

        // Funci√≥n para actualizar el bot√≥n activo
        function updateActiveButton(groupSelector, activeId) {
            document.querySelectorAll(`${groupSelector} .btn`).forEach(btn => btn.classList.remove('active'));
            const activeButton = document.getElementById(activeId);
            if (activeButton) {
                activeButton.classList.add('active');
            }
        }
    
        // Incrementar o decrementar copias
        function updateCopies(delta) {
            const copiesInput = document.getElementById('copias');
            let copies = parseInt(copiesInput.value) + delta;
            copies = Math.max(1, copies);
            copiesInput.value = copies;
            console.log("se pulsa pero no se actualiza")
            updateConfigInActiveFolder('copias', copies);
            calculatePrice();
            sendConfigUpdate();
        }
    
        // Seleccionar color
        function selectColor(color) {
            document.getElementById('color-input').value = color;
            updateActiveButton('#color-impresion', `color-${color.toLowerCase().replace(/\s/g, '')}`);
    
            updateConfigInActiveFolder('color', color);
            calculatePrice();
            sendConfigUpdate();
        }
    
        // Seleccionar entre una cara y doble cara
        function selectEstructura(cara) {
            document.getElementById('cara-input').value = cara;
            updateActiveButton('#cara-impresion', `cara-${cara.toLowerCase()}`);
    
            updateConfigInActiveFolder('cara', cara);
            calculatePrice();
            sendConfigUpdate();
        }
    
        // Actualizar configuraci√≥n en la carpeta activa
        function updateConfigInActiveFolder(key, value) {
            const folderName = document.getElementById('active-folder').value;
            const folderElement = document.querySelector(`[data-folder-name="${folderName}"]`);

            if (folderElement) {
                // Actualiza la configuraci√≥n en el atributo data-config
                const folderConfig = JSON.parse(folderElement.getAttribute('data-config'));
                folderConfig[key] = value; // Actualizar la clave espec√≠fica
                folderElement.setAttribute('data-config', JSON.stringify(folderConfig));

                // Enviar al backend
                sendConfigUpdate();
            }
        }

    
        // Calcular el precio din√°mico
        function calculatePrice() {
            const folders = document.querySelectorAll('.folder-item');
            let totalPrice = 0;

            folders.forEach(folder => {
                const config = JSON.parse(folder.getAttribute('data-config'));
                const fileGrid = folder.querySelector('.file-grid');
                let pages = 0;

                // Calcular el n√∫mero total de p√°ginas
                if (fileGrid) {
                    const files = Array.from(fileGrid.querySelectorAll('.file-item'));
                    files.forEach(file => {
                        const fileText = file.querySelector('.file-name').innerText;
                        const pagesMatch = fileText.match(/(\d+)\s+p√°ginas/);
                        if (pagesMatch) {
                            pages += parseInt(pagesMatch[1]);
                        }
                    });
                }

                const copies = parseInt(config.copias || 1);
                const color = config.color === 'Color' ? 'color' : 'byn';
                const cara = config.cara === 'Doble' ? 'dos_caras' : 'una_cara';
                const encuadernacion = config.encuadernacion || 'hasta_50_hojas';

                // Calcular precio por p√°gina y encuadernaci√≥n
                const perPagePrice = PRICES[color]?.[cara] || 0;
                const encuadernacionPrice = PRICES.encuadernacion_a4?.[encuadernacion] || 0;

                // Calcular el precio total para esta carpeta
                totalPrice += pages * copies * perPagePrice + encuadernacionPrice;
            });

            // Calcular el precio de env√≠o
            const modalidadEnvio = document.getElementById('modalidad-envio').value;
            const envioPrice = PRICES.recogida?.[modalidadEnvio] || 0;

            // Actualizar los totales en el DOM
            document.getElementById('totalPrize').innerText = `Subtotal: ${totalPrice.toFixed(2)} ‚Ç¨`;
            document.getElementById('envioPrice').innerText = `Env√≠o: ${envioPrice.toFixed(2)} ‚Ç¨`;
            document.getElementById('finalPrice').innerText = `Total final: ${(totalPrice + envioPrice).toFixed(2)} ‚Ç¨`;
        }





    
        // Sincronizar con el backend
        function sendConfigUpdate() {
            const configForm = document.getElementById('config-form');
            const formData = new FormData(configForm);

            fetch('/', {
                method: 'POST',
                body: formData,
            })
                .then(response => {
                    if (response.ok) {
                        console.log('Configuraci√≥n actualizada.');
                    } else {
                        console.error('Error al guardar configuraci√≥n.');
                    }
                })
                .catch(error => console.error('Error al enviar la configuraci√≥n:', error));
        }

        
        function addToCart() {
            hideErrors();

            const modalidadEnvio = document.getElementById('modalidad-envio').value;

            if (!modalidadEnvio || (modalidadEnvio !== "tienda" && modalidadEnvio !== "domicilio")) {
                showError("Por favor, selecciona una modalidad de env√≠o.");
                return;
            }

            const cartTotalText = document.getElementById("totalPrize").innerText.replace("Subtotal: ", "").replace("‚Ç¨", "").trim();
            const cartTotal = parseFloat(cartTotalText) || 0;

            const envioPriceText = document.getElementById("envioPrice").innerText.replace("Env√≠o: ", "").replace("‚Ç¨", "").trim();
            const envioPrice = parseFloat(envioPriceText) || 0;

            const formData = new FormData();
            formData.append("action", "add_to_cart");
            formData.append("cart_total", cartTotal);
            formData.append("envio_total", envioPrice);

            if (modalidadEnvio === "domicilio") {
                const name = document.getElementById('name').value;
                const direccion = document.getElementById('direccion').value;
                const provincia = document.getElementById('provincia').value;
                const email = document.getElementById('email').value;
                const telefono = document.getElementById('telefono').value;

                if (!name || !direccion || !provincia || !email || !telefono) {
                    showError("Por favor, completa todos los campos del formulario de env√≠o.");
                    return;
                }

                formData.append("name", name);
                formData.append("direccion", direccion);
                formData.append("provincia", provincia);
                formData.append("email", email);
                formData.append("telefono", telefono);
            }

            fetch("/", {
                method: "POST",
                body: formData,
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log("Carrito actualizado correctamente.");
                        window.location.href = "/cart";
                    } else {
                        console.error("Error al actualizar el carrito.");
                    }
                })
                .catch(error => console.error("Error al actualizar el carrito:", error));
        }

        function getLocalCartTotal() {
            const cartTotalText = document.getElementById("totalPrize").innerText;
            return parseFloat(cartTotalText.replace("‚Ç¨", "")) || 0;
        }

        function toggleUploadButton(folderName) {
            const fileInput = document.getElementById(`fileInput-${folderName}`);
            const uploadButton = document.getElementById(`uploadButton-${folderName}`);

            if (fileInput.files.length > 0) {
                uploadButton.disabled = false; // Habilita el bot√≥n si hay archivos seleccionados
            } else {
                uploadButton.disabled = true; // Deshabilita el bot√≥n si no hay archivos
            }
        }

        function checkFolders() {
            const foldersContainer = document.getElementById('folders');
            const noFoldersContainer = document.getElementById('no-folders');

            // Si no hay carpetas, muestra el mensaje
            if (foldersContainer.children.length === 0) {
                noFoldersContainer.style.display = 'block';
            } else {
                noFoldersContainer.style.display = 'none';
            }
        }

        function selectEnvio(modalidad) {
            const envioInput = document.getElementById('modalidad-envio');
            envioInput.value = modalidad;

            const buttons = document.querySelectorAll('#envio-opciones .btn');
            buttons.forEach(button => button.classList.remove('active'));

            const activeButton = document.getElementById(`envio-${modalidad}`);
            if (activeButton) {
                activeButton.classList.add('active');
            }

            // Mostrar u ocultar formulario de env√≠o
            const formEnvioDomicilio = document.getElementById('form-envio-domicilio');
            if (modalidad === 'domicilio') {
                formEnvioDomicilio.style.display = 'block';
            } else {
                formEnvioDomicilio.style.display = 'none';
            }

            calculatePrice();
        }


        // Llama a esta funci√≥n cuando se cargue la p√°gina
        document.addEventListener('DOMContentLoaded', checkFolders);
        function showError(message) {
            const errorDiv = document.getElementById('validation-errors');

            // Aseg√∫rate de que el mensaje existe
            if (!errorDiv) {
                console.error("No se encontr√≥ el contenedor de errores.");
                return;
            }

            // Establece el mensaje de error
            errorDiv.innerText = message;

            // A√±ade la clase `show` para hacer visible el mensaje
            errorDiv.classList.add('show');

            // Oculta el mensaje despu√©s de 7 segundos
            setTimeout(() => {
                hideErrors();
            }, 7000);
        }

        function hideErrors() {
            const errorDiv = document.getElementById('validation-errors');

            // Aseg√∫rate de que el contenedor existe
            if (!errorDiv) {
                console.error("No se encontr√≥ el contenedor de errores.");
                return;
            }

            // Quita la clase `show` para ocultar el mensaje
            errorDiv.classList.remove('show');
        }

// Si eliminas o agregas carpetas din√°micamente, aseg√∫rate de volver a llamar a `checkFolders`

    </script>
    
    
</body>
</html>
